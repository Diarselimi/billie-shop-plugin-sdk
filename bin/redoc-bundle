#!/usr/bin/env bash

command -v npx >/dev/null 2>&1 || {
    echo "ERROR: npm / npx are not installed. Aborting API docs generation..."
    exit 1
}

BILLIE_ORANGE_COLOR="#ff4338"
BILLIE_BLUE_COLOR="#1f2530"
TEXT_COLOR=${BILLIE_BLUE_COLOR}
TEXT_SECONDARY_COLOR="#505f7c"
SUCCESS_COLOR="#6bbd5b"
ERROR_COLOR="#ED6456"

LOGO_PADDING="40px"
LOGO_MAX_HEIGHT="160px"
MAIN_FONT="Roboto, Helvetica, sans-serif"
HEADING_FONT="Monserrat, Helvetica, sans-serif"
HEADING_FONT_WEIGHT="bold"
VERTICAL_SPACING="20"

SPEC_GROUP=${1:-"public"}
SPEC_VERSION=${2:-$(git describe --tags 2> /dev/null || echo "dev")}
SPEC_FILE="paella-openapi-${SPEC_GROUP}.yaml"

if [[ ${SPEC_GROUP} = "public" ]]; then
   SPEC_TITLE="Billie - PaD API Documentation"
else
   SPEC_TITLE="Billie - PaD API Documentation (${SPEC_GROUP})"
fi

echo "Generating API YAML specification (version: ${SPEC_VERSION})..."

mkdir -p docs/openapi
rm -f docs/openapi/${SPEC_FILE}

bin/console paella:openapi:generate ${SPEC_VERSION} \
        --output-file="docs/openapi/${SPEC_FILE}" --title="${SPEC_TITLE}" --groups=${SPEC_GROUP}

if [[ ! -f docs/openapi/${SPEC_FILE} ]]; then
    echo "ERROR: Open API generation failed. Spec. file does not exist."
    exit 1;
fi

echo "Generating API HTML documentation (version: ${SPEC_VERSION})..."

SPEC_HTML_FILE=docs/openapi/${SPEC_FILE/yaml/html}
rm -f ${SPEC_HTML_FILE}

npx redoc-cli bundle "docs/openapi/${SPEC_FILE}" \
--title="${SPEC_TITLE}" \
--options.theme.colors.primary.main="${BILLIE_ORANGE_COLOR}" \
--options.theme.rightPanel.backgroundColor="${BILLIE_BLUE_COLOR}" \
--options.theme.colors.text.primary="${TEXT_COLOR}" \
--options.theme.colors.text.secondary="${TEXT_SECONDARY_COLOR}" \
--options.theme.colors.success.main="${SUCCESS_COLOR}" \
--options.theme.colors.error.main="${ERROR_COLOR}" \
--options.theme.logo.gutter="${LOGO_PADDING}" \
--options.theme.logo.maxHeight="${LOGO_MAX_HEIGHT}" \
--options.theme.typography.fontFamily="${MAIN_FONT}" \
--options.theme.typography.headings._fontFamily="${HEADING_FONT}" \
--options.theme.typography.headings.fontWeight="${HEADING_FONT_WEIGHT}" \
--options.theme.spacing.sectionVertical="${VERTICAL_SPACING}" \
--options.expandResponses="200,201,202" \
--options.pathInMiddlePanel=1 \
-t docs/openapi/resources/template.hbs || exit 1

mv redoc-static.html ${SPEC_HTML_FILE}

echo "DONE."
